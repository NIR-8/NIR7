<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light only">
    <title>NIR8 Chat Calculator</title>

    <!-- MathJax configuration -->
    <script>
        MathJax = {
            loader: { load: ['input/tex', 'output/chtml'] },
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                packages: {'[+]': ['base', 'ams']},
                processEscapes: true
            },
            chtml: { scale: 0.9, mtextInheritFont: true },
            startup: {
                typeset: false,
                pageReady() {
                    MathJax.startup.defaultPageReady();
                    document.dispatchEvent(new Event('MathJaxReady'));
                }
            }
        };
    </script>

    <!-- Load local Decimal.js with fallback -->
    <script src="decimal.min.js" onerror="loadDecimalFallback()"></script>
    <script>
        function loadDecimalFallback() {
            console.warn('Local Decimal.js failed to load. Attempting to load from CDN...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js';
            script.async = true;
            script.onerror = () => {
                console.error('Failed to load Decimal.js from CDN. Some calculations may not work correctly.');
                alert('Unable to load Decimal.js. Please check your network connection or ensure the local file is available.');
            };
            script.onload = () => {
                console.log('Decimal.js loaded successfully from CDN.');
                initializeDecimal();
            };
            document.head.appendChild(script);
        }

        function initializeDecimal() {
            if (typeof Decimal !== 'undefined') {
                Decimal.set({ precision: 20, toExpNeg: -9, toExpPos: 20 });
            }
        }

        if (typeof Decimal !== 'undefined') {
            initializeDecimal();
        }
    </script>

    <!-- Load local MathJax with fallback -->
    <script src="assets/mathjax/es5/tex-mml-chtml.js" onerror="loadMathJaxFallback()" async></script>
    <script>
        function loadMathJaxFallback(attempt = 1, maxAttempts = 2) {
            console.warn(`Local MathJax failed to load. Attempting to load from CDN (Attempt ${attempt}/${maxAttempts})...`);
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
            script.async = true;
            script.onerror = () => {
                if (attempt < maxAttempts) {
                    console.warn(`MathJax CDN attempt ${attempt} failed. Retrying...`);
                    loadMathJaxFallback(attempt + 1, maxAttempts);
                } else {
                    console.error('Failed to load MathJax from CDN after multiple attempts.');
                    alert('Unable to load MathJax. Equations will be displayed as plain text.');
                    document.dispatchEvent(new Event('MathJaxReady'));
                }
            };
            script.onload = () => {
                console.log('MathJax loaded successfully from CDN.');
                MathJax.startup.getComponents();
            };
            document.head.appendChild(script);
        }
    </script>

    <style>
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        /* Chat Interface */
        .chat-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .chat-header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .mode-indicator {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Main Layout */
        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .sidebar-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-section h3 i {
            color: #4facfe;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            background: white;
            border: 2px solid #e9ecef;
            color: #333;
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-btn:hover {
            border-color: #4facfe;
            background: #f0f8ff;
            transform: translateX(5px);
        }

        .action-btn.active {
            border-color: #4facfe;
            background: #4facfe;
            color: white;
        }

        .action-btn i {
            font-size: 16px;
        }

        /* Status Panel */
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .status-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-value {
            font-weight: 600;
            font-size: 18px;
            color: #4facfe;
            cursor: pointer;
        }

        .status-value:hover {
            text-decoration: underline;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #fafafa;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f5f7fa;
        }

        /* Messages */
        .message {
            max-width: 80%;
            padding: 20px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            background: white;
            border: 1px solid #e9ecef;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.user {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.system {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-size: 14px;
            color: #856404;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .bot-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .message-sender {
            font-weight: 600;
            color: #4facfe;
        }

        .message-time {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            text-align: right;
        }

        /* Calculation Steps (From Original) */
        .calculation-steps {
            margin-top: 20px;
            padding: 15px;
            width: 100%;
            background: #fff;
            border-radius: 0;
            box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
            color: #555;
            text-align: left;
            position: relative;
            padding-top: 20px;
            will-change: transform;
            display: none;
        }

        .calculation-steps.active {
            display: block;
        }

        .calculation-entry {
            margin-bottom: 15px;
            border: 1px solid #000;
            padding: 15px;
            position: relative;
            width: 100%;
            min-height: 200px;
            font-size: 14pt;
            border-radius: 0;
            box-sizing: border-box;
            contain: content;
            overflow: hidden;
        }

        .calculation-entry::before {
            content: "Assay Based Calculation";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: #f0f0f0;
            padding: 5mm;
            text-align: center;
            font-size: 16pt;
            font-weight: 600;
            border-bottom: 1px solid #000;
            box-sizing: border-box;
        }

        .calculation-entry::after {
            content: "Remarks: ______________________________________________________________";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #f0f0f0;
            padding: 5mm;
            font-size: 14pt;
            border-top: 1px solid #000;
            box-sizing: border-box;
        }

        .calculation-entry .lot-label::before {
            content: "LOT: ";
            position: absolute;
            top: 24mm;
            left: 15mm;
            font-size: 14pt;
        }

        .reference-values {
            position: absolute;
            top: 24mm;
            right: 15mm;
            font-size: 10pt;
            color: #000;
            z-index: 10;
        }

        .calculation-content {
            margin-top: 30mm;
            margin-bottom: 30mm;
            padding: 0 15mm;
            overflow: hidden;
            font-size: 14pt;
        }

        .page-number {
            position: absolute;
            bottom: 1mm;
            right: 4mm;
            font-size: 8pt;
            color: #000;
            font-weight: 700;
            z-index: 5;
        }

        .delete-button {
            position: absolute;
            top: 10px;
            left: 10px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: red;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }

        .input-area input {
            flex: 1;
            padding: 16px 24px;
            border: 2px solid #e9ecef;
            border-radius: 50px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .input-area input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .input-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .input-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        /* Suggestions */
        .suggestions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            overflow-x: auto;
            flex-shrink: 0;
        }

        .suggestion-chip {
            background: #f1f8ff;
            border: 1px solid #d1e9ff;
            color: #4facfe;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .suggestion-chip:hover {
            background: #4facfe;
            color: white;
            transform: translateY(-2px);
        }

        /* Forms */
        .form-inputs {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .calc-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .calc-btn.f1 { background: #4facfe; color: white; }
        .calc-btn.f2 { background: #00f2fe; color: white; }
        .calc-btn.f3 { background: #28a745; color: white; }

        .calc-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Results */
        .result-display {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
            font-family: monospace;
            font-size: 14px;
        }

        /* ACB Calculator */
        .acb-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-family: Poppins, sans-serif;
            table-layout: auto;
        }

        .acb-td, .acb-th {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 14px;
            min-width: 60px;
            word-wrap: break-word;
            white-space: normal;
        }

        .acb-th {
            background-color: #f2f2f2;
            color: #444;
            font-weight: 600;
        }

        .acb-input {
            width: calc(100% - 16px);
            padding: 6px;
            margin: 2px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
            background: transparent;
            transition: border-color .3s ease;
        }

        /* Print Styles (From Original) */
        @media print {
            @page {
                size: A4 landscape;
                margin: 8mm;
            }

            body {
                background: transparent;
                padding: 0;
                margin: 0;
            }

            .chat-container, .sidebar, .input-area, .suggestions, .delete-button {
                display: none !important;
            }

            .calculation-steps {
                display: block !important;
                width: 100%;
                max-width: none;
                margin: 0;
                padding: 0;
                background: transparent;
            }

            .calculation-entry {
                width: 280mm !important;
                height: 190mm !important;
                margin: 0 auto;
                padding: 0;
                border: 1px solid #000;
                font-size: 12pt;
                position: relative;
                background: #fff;
                overflow: hidden;
                page-break-after: always;
            }
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .chat-container {
                height: calc(100vh - 20px);
            }
            
            .sidebar {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .chat-container {
                height: calc(100vh - 20px);
                border-radius: 15px;
            }
            
            .chat-main {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .messages-container {
                padding: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .form-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .chat-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px;
            }
            
            .chat-header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .input-area input {
                padding: 14px;
                font-size: 14px;
            }
            
            .suggestion-chip {
                padding: 8px 16px;
                font-size: 12px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            color: #155724;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            background: white;
            border-radius: 18px;
            border: 1px solid #e9ecef;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <h1>ü§ñ NIR8 Chat Calculator</h1>
            <div class="chat-header-controls">
                <div class="mode-indicator" id="modeIndicator">Ready</div>
                <button class="input-btn" onclick="printAllCalculations()" title="Print All Calculations">üñ®Ô∏è</button>
                <button class="input-btn" onclick="clearAllCalculations()" title="Clear All Calculations">üóëÔ∏è</button>
            </div>
        </div>

        <!-- Main Area -->
        <div class="chat-main">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>üöÄ Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="action-btn" onclick="sendMessage('help')">
                            <i>‚ùì</i> Get Started
                        </button>
                        <button class="action-btn active" onclick="showFormulaCalculator()">
                            <i>üßÆ</i> Formula Calculator
                        </button>
                        <button class="action-btn" onclick="showACBCalculator()">
                            <i>üìä</i> (A+C)-B Calculator
                        </button>
                        <button class="action-btn" onclick="sendMessage('show quantities')">
                            <i>üìà</i> Track Quantities
                        </button>
                        <button class="action-btn" onclick="printAllCalculations()">
                            <i>üñ®Ô∏è</i> Print Report
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>üìä Current Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Calculations</div>
                            <div class="status-value" id="statusCalculations">0</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Std Qty (kg)</div>
                            <div class="status-value" id="statusStdQty" onclick="promptSetStdQty()">0.000</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Dispensed</div>
                            <div class="status-value" id="statusDispensed">0.000</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Remaining</div>
                            <div class="status-value" id="statusRemaining" onclick="useRemainingAsQ()">0.000</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>üí° Quick Examples</h3>
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <p><strong>Formulas:</strong><br>
                        "Calculate F1 Q=100 W=5 A=95"<br>
                        "Calculate F2 with Q=500"<br>
                        "F3 Q=1000 W=3 A=98"</p>
                        
                        <p><strong>Quantity:</strong><br>
                        "Set std qty 1500"<br>
                        "Show quantities"<br>
                        "Clear calculations"</p>
                        
                        <p><strong>ACB:</strong><br>
                        "ACB Lot 1 B=100"<br>
                        "Show ACB totals"<br>
                        "Reset ACB"</p>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Messages -->
                <div class="messages-container" id="messagesContainer">
                    <div class="message system">
                        Welcome to NIR8 Chat Calculator! I can help you with formula calculations, quantity tracking, and (A+C)-B calculations. Type your commands or use the quick actions.
                    </div>
                </div>

                <!-- Suggestions -->
                <div class="suggestions" id="suggestions">
                    <div class="suggestion-chip" onclick="sendMessage('Calculate F1')">Calculate F1</div>
                    <div class="suggestion-chip" onclick="sendMessage('Calculate F2')">Calculate F2</div>
                    <div class="suggestion-chip" onclick="sendMessage('Calculate F3')">Calculate F3</div>
                    <div class="suggestion-chip" onclick="sendMessage('Set std qty 1000')">Set Std Qty</div>
                    <div class="suggestion-chip" onclick="showACBCalculator()">ACB Calculator</div>
                    <div class="suggestion-chip" onclick="clearChat()">Clear Chat</div>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <input type="text" id="userInput" 
                           placeholder="Type your command here (e.g., 'Calculate F1 Q=100 W=5 A=95')..." 
                           onkeypress="handleInputKeyPress(event)">
                    <button class="input-btn" onclick="sendUserMessage()">‚Üµ</button>
                </div>
            </div>
        </div>

        <!-- Hidden Calculation Steps Container (From Original) -->
        <div class="calculation-steps hidden" id="calculationSteps" role="region" aria-label="Calculation steps">
            <button type="button" onclick="printWithCheck()" class="calc-btn" style="background: #007bff; color: white; margin-bottom: 20px;">Print Calculations</button>
            <div id="stepsContainer"></div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONSTANTS & CONFIGURATION (From Original)
        // ============================================================================
        const CONSTANTS = {
            MAX_CALCULATIONS: 15,
            ACB_DEFAULT_A: 417.000,
            ACB_DEFAULT_C: 84.375,
            ACB_TOTAL_A: 1668.000,
            ACB_TOTAL_C: 337.500,
            Q_MAX: 9999999,
            W_MAX: 99.99,
            A_MAX: 100.00,
            MATHJAX_TIMEOUT: 10000
        };

        // Configure Decimal.js
        Decimal.set({ precision: 20, toExpNeg: -9, toExpPos: 20 });

        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================
        const state = {
            // Chat state
            currentMode: 'ready',
            messages: [],
            calculations: [],
            
            // Formula calculator state
            formulaState: {
                Q: '',
                W: '',
                A: '',
                formulaType: null
            },
            
            // Quantity tracking
            quantities: {
                stdQty: 0,
                dispensedQty: 0,
                remainingQty: 0
            },
            
            // ACB calculator state
            acbState: {
                values: {
                    a: [CONSTANTS.ACB_DEFAULT_A, CONSTANTS.ACB_DEFAULT_A, CONSTANTS.ACB_DEFAULT_A, CONSTANTS.ACB_DEFAULT_A],
                    b: [0, 0, 0, 0],
                    c: [CONSTANTS.ACB_DEFAULT_C, CONSTANTS.ACB_DEFAULT_C, CONSTANTS.ACB_DEFAULT_C, CONSTANTS.ACB_DEFAULT_C]
                },
                totals: {
                    a: CONSTANTS.ACB_TOTAL_A,
                    b: 0,
                    c: CONSTANTS.ACB_TOTAL_C,
                    result: 0
                }
            }
        };

        // ============================================================================
        // DOM ELEMENTS
        // ============================================================================
        const elements = {
            // Chat elements
            messagesContainer: document.getElementById('messagesContainer'),
            userInput: document.getElementById('userInput'),
            suggestions: document.getElementById('suggestions'),
            modeIndicator: document.getElementById('modeIndicator'),
            
            // Status elements
            statusCalculations: document.getElementById('statusCalculations'),
            statusStdQty: document.getElementById('statusStdQty'),
            statusDispensed: document.getElementById('statusDispensed'),
            statusRemaining: document.getElementById('statusRemaining'),
            
            // Calculation steps (from original)
            calculationSteps: document.getElementById('calculationSteps'),
            stepsContainer: document.getElementById('stepsContainer')
        };

        // ============================================================================
        // UTILITY FUNCTIONS (From Original)
        // ============================================================================
        function truncateTo12Digits(num) {
            try {
                const numStr = new Decimal(num).toString();
                const isNegative = numStr.startsWith("-");
                const absNumStr = isNegative ? numStr.slice(1) : numStr;
                let result = isNegative ? "-" : "";
                let digitCount = 0;
                for (let i = 0; i < absNumStr.length && digitCount < 12; i++) {
                    if (absNumStr[i] === ".") {
                        result += ".";
                    } else {
                        result += absNumStr[i];
                        digitCount++;
                    }
                }
                return result;
            } catch {
                return num.toString();
            }
        }

        function formatNumber(num, isAW = false) {
            try {
                const d = new Decimal(num);
                const formatted = isAW ? d.toFixed(2) : d.toFixed(3);
                return truncateTo12Digits(formatted);
            } catch {
                return num.toString();
            }
        }

        // ============================================================================
        // CHAT FUNCTIONS
        // ============================================================================
        function addMessage(type, content, showTime = true) {
            const message = {
                id: Date.now(),
                type,
                content,
                timestamp: new Date(),
                showTime
            };
            
            state.messages.push(message);
            renderMessage(message);
            
            // Auto-scroll to bottom
            setTimeout(() => {
                elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
            }, 100);
        }

        function renderMessage(message) {
            const container = elements.messagesContainer;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            
            const time = message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let content = '';
            if (message.type === 'bot') {
                content = `
                    <div class="message-header">
                        <div class="bot-avatar">AI</div>
                        <div class="message-sender">NIR8 Assistant</div>
                    </div>
                    <div>${message.content}</div>
                `;
            } else {
                content = `<div>${message.content}</div>`;
            }
            
            if (message.showTime) {
                content += `<div class="message-time">${time}</div>`;
            }
            
            messageDiv.innerHTML = content;
            container.appendChild(messageDiv);
        }

        function showTypingIndicator() {
            const container = elements.messagesContainer;
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-header">
                    <div class="bot-avatar">AI</div>
                    <div class="message-sender">NIR8 Assistant</div>
                </div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
            
            return typingDiv;
        }

        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // ============================================================================
        // MESSAGE PROCESSING
        // ============================================================================
        async function processMessage(text) {
            text = text.trim().toLowerCase();
            
            if (!text) return;
            
            // Show typing indicator
            showTypingIndicator();
            
            // Process after delay for realistic typing
            setTimeout(() => {
                removeTypingIndicator();
                
                // Process the message
                const response = routeMessage(text);
                addMessage('bot', response);
                
                // Update status
                updateStatus();
            }, 500);
        }

        function routeMessage(text) {
            // Check for formula calculations
            if (text.includes('calculate') || text.includes('f1') || text.includes('f2') || text.includes('f3')) {
                return handleFormulaCommand(text);
            }
            
            // Check for quantity commands
            if (text.includes('qty') || text.includes('quantity') || text.includes('std')) {
                return handleQuantityCommand(text);
            }
            
            // Check for ACB commands
            if (text.includes('acb') || text.includes('lot') || text.includes('a+c') || text.includes('(a+c)-b')) {
                return handleACBCommand(text);
            }
            
            // Check for help
            if (text.includes('help') || text.includes('start')) {
                return getHelpMessage();
            }
            
            // Check for clear
            if (text.includes('clear')) {
                return handleClearCommand(text);
            }
            
            // Check for print
            if (text.includes('print') || text.includes('report')) {
                return handlePrintCommand();
            }
            
            // Default response
            return "I'm not sure what you mean. Try saying 'help' to see available commands, or use one of the quick actions.";
        }

        // ============================================================================
        // FORMULA CALCULATION FUNCTIONS (From Original - Adapted)
        // ============================================================================
        function handleFormulaCommand(text) {
            // Extract parameters from text
            const params = extractParamsFromText(text);
            
            // Determine formula type
            let formulaType = 'F1';
            if (text.includes('f2')) formulaType = 'F2';
            if (text.includes('f3')) formulaType = 'F3';
            
            // If all parameters are provided, calculate directly
            if (params.Q && params.W && params.A) {
                return performFormulaCalculation(formulaType, params.Q, params.W, params.A);
            }
            
            // Otherwise, start interactive mode
            state.currentMode = 'formula_input';
            state.formulaState.formulaType = formulaType;
            
            let response = `Let's calculate ${formulaType}. `;
            
            if (!params.Q) {
                response += "Please enter Quantity (Q):";
                state.formulaState.step = 'Q';
            } else if (!params.W) {
                response += `Got Q = ${params.Q}. Please enter Water Content (W):`;
                state.formulaState.Q = params.Q;
                state.formulaState.step = 'W';
            } else if (!params.A) {
                response += `Got Q = ${params.Q}, W = ${params.W}. Please enter Assay Content (A):`;
                state.formulaState.Q = params.Q;
                state.formulaState.W = params.W;
                state.formulaState.step = 'A';
            }
            
            return response;
        }

        function extractParamsFromText(text) {
            const params = {};
            
            // Extract Q
            const qMatch = text.match(/(?:q|quantity)[=:\s]+([\d.]+)/i);
            if (qMatch) params.Q = parseFloat(qMatch[1]);
            
            // Extract W
            const wMatch = text.match(/(?:w|water)[=:\s]+([\d.]+)/i);
            if (wMatch) params.W = parseFloat(wMatch[1]);
            
            // Extract A
            const aMatch = text.match(/(?:a|assay)[=:\s]+([\d.]+)/i);
            if (aMatch) params.A = parseFloat(aMatch[1]);
            
            return params;
        }

        function performFormulaCalculation(formulaType, Q, W, A) {
            try {
                // Validate inputs
                Q = parseFloat(Q);
                W = parseFloat(W);
                A = parseFloat(A);
                
                if (isNaN(Q) || isNaN(W) || isNaN(A)) {
                    return "‚ùå Invalid input values. Please enter valid numbers.";
                }
                
                if (Q <= 0 || W <= 0 || A <= 0) {
                    return "‚ùå All values must be greater than 0.";
                }
                
                if (Q > CONSTANTS.Q_MAX) {
                    return `‚ùå Quantity (Q) must be less than or equal to ${CONSTANTS.Q_MAX}.`;
                }
                
                if (A > CONSTANTS.A_MAX || W > CONSTANTS.W_MAX) {
                    return "‚ùå Invalid values: Ensure A ‚â§ 100 and W ‚â§ 99.99.";
                }
                
                // Perform calculation using original functions
                const calculation = createCalculation(formulaType, new Decimal(Q), new Decimal(W), new Decimal(A));
                
                if (!calculation) {
                    return "‚ùå Calculation failed. Please check your inputs.";
                }
                
                // Add to calculations
                state.calculations.push({
                    ...calculation,
                    timestamp: new Date()
                });
                
                // Update dispensed quantity
                updateDispensedQuantity(formulaType, Q, calculation.result);
                
                // Show calculation in chat
                let response = `‚úÖ ${formulaType} Calculation Complete!\n\n`;
                response += `**Parameters:**\n`;
                response += `- Quantity (Q): ${formatNumber(Q)}\n`;
                response += `- Water Content (W): ${formatNumber(W, true)}%\n`;
                response += `- Assay Content (A): ${formatNumber(A, true)}%\n\n`;
                response += `**Result:** ${formatNumber(calculation.result)}`;
                
                // Also add to original calculation steps for printing
                addToCalculationSteps(calculation);
                
                state.currentMode = 'ready';
                return response;
                
            } catch (error) {
                console.error('Calculation error:', error);
                return `‚ùå Calculation error: ${error.message}`;
            }
        }

        function createCalculation(formulaType, Q, W, A) {
            try {
                const hundred = new Decimal(100);
                const formattedQ = formatNumber(Q);
                const formattedA = formatNumber(A, true);
                const formattedW = formatNumber(W, true);

                if (formulaType === "F1" || formulaType === "F3") {
                    const step1 = Q.mul(hundred);
                    const step2 = step1.mul(hundred);
                    const step3 = hundred.sub(W);
                    const step4 = A.mul(step3);
                    const numerator = step2;
                    const denominator = step4;
                    if (denominator.isZero()) throw new Error("Division by zero");
                    const result = numerator.div(denominator);
                    const roundedResult = result.toFixed(3);

                    return {
                        mathJax: `
                            $$ F_${formulaType === "F1" ? "1" : "3"} = \\frac{${formattedQ} \\times 100 \\times 100}{${formattedA} \\times (100 - ${formattedW})} $$ <br><br>
                            $$ = \\frac{${formattedQ} \\times 100 \\times 100}{${formattedA} \\times ${formatNumber(step3)}} $$ <br><br>
                            $$ = \\frac{${formatNumber(numerator)}}{${formatNumber(denominator)}} $$ <br><br>
                            $$ = ${truncateTo12Digits(roundedResult)} \\text{ (original: } ${formatNumber(result)} \\text{)} $$
                        `,
                        plainText: `
                            F${formulaType === "F1" ? "1" : "3"} = (${formattedQ} √ó 100 √ó 100) / (${formattedA} √ó (100 - ${formattedW}))
                            <br><br>
                            = (${formattedQ} √ó 100 √ó 100) / (${formattedA} √ó ${formatNumber(step3)})
                            <br><br>
                            = ${formatNumber(numerator)} / ${formatNumber(denominator)}
                            <br><br>
                            = ${truncateTo12Digits(roundedResult)} <br> (original: ${formatNumber(result)})
                        `,
                        formulaType,
                        Q: Q.toString(),
                        W: W.toString(),
                        A: A.toString(),
                        result: roundedResult,
                        isFinal: true
                    };
                } else if (formulaType === "F2") {
                    const step1 = hundred.sub(W);
                    const step2 = A.mul(step1);
                    const step3 = Q.mul(step2);
                    const denominator = hundred.mul(hundred);
                    const numerator = step3;
                    const result = numerator.div(denominator);
                    const roundedResult = result.toFixed(3);

                    return {
                        mathJax: `
                            $$ F_2 = \\frac{${formattedQ} \\times ${formattedA} \\times (100 - ${formattedW})}{100 \\times 100} $$ <br><br>
                            $$ = \\frac{${formattedQ} \\times ${formattedA} \\times ${formatNumber(step1)}}{${formatNumber(denominator)}} $$ <br><br>
                            $$ = \\frac{${formatNumber(numerator)}}{${formatNumber(denominator)}} $$ <br><br>
                            $$ = ${truncateTo12Digits(roundedResult)} \\text{ (original: } ${formatNumber(result)} \\text{)} $$
                        `,
                        plainText: `
                            F2 = (${formattedQ} √ó ${formattedA} √ó (100 - ${formattedW})) / (100 √ó 100)
                            <br><br>
                            = (${formattedQ} √ó ${formattedA} √ó ${formatNumber(step1)}) / ${formatNumber(denominator)}
                            <br><br>
                            = ${formatNumber(numerator)} / ${formatNumber(denominator)}
                            <br><br>
                            = ${truncateTo12Digits(roundedResult)} <br> (original: ${formatNumber(result)})
                        `,
                        formulaType,
                        Q: Q.toString(),
                        W: W.toString(),
                        A: A.toString(),
                        result: roundedResult,
                        isFinal: false
                    };
                }
                return null;
            } catch (err) {
                console.error("Calculation error:", err);
                throw err;
            }
        }

        function addToCalculationSteps(calculation) {
            const newEntry = document.createElement("div");
            newEntry.className = "calculation-entry";
            newEntry.setAttribute("tabindex", "0");
            newEntry.setAttribute("role", "region");
            newEntry.setAttribute("aria-label", `Calculation ${calculation.formulaType}`);
            newEntry.innerHTML = `
                <button type="button" class="delete-button" onclick="deleteCalculation(this)" title="Delete" aria-label="Delete calculation">‚ùå</button>
                <div class="lot-label"></div>
                <div class="reference-values">W="${formatNumber(calculation.W, true)}" A="${formatNumber(calculation.A, true)}"</div>
                <div class="calculation-content">${calculation.plainText}</div>
                <div class="page-number">${state.calculations.length}/${state.calculations.length}</div>
            `;

            elements.stepsContainer.insertBefore(newEntry, elements.stepsContainer.firstChild);
            elements.calculationSteps.classList.remove("hidden");
            
            // Update MathJax if available
            if (typeof MathJax !== 'undefined' && MathJax.typeset) {
                setTimeout(() => {
                    MathJax.typeset([newEntry]);
                }, 100);
            }
        }

        // ============================================================================
        // QUANTITY TRACKING FUNCTIONS
        // ============================================================================
        function handleQuantityCommand(text) {
            const num = extractNumber(text);
            
            if (text.includes('set') || text.includes('std')) {
                if (!isNaN(num) && num > 0) {
                    state.quantities.stdQty = num;
                    updateQuantities();
                    return `‚úÖ Standard quantity set to ${formatNumber(num)} kg`;
                } else {
                    return "‚ùå Please provide a valid quantity (e.g., 'Set std qty 1000')";
                }
            }
            
            if (text.includes('show') || text.includes('display')) {
                return getQuantityStatus();
            }
            
            return getQuantityStatus();
        }

        function getQuantityStatus() {
            return `üìä **Quantity Status:**\n\n` +
                   `‚Ä¢ Standard Qty: ${formatNumber(state.quantities.stdQty)} kg\n` +
                   `‚Ä¢ Dispensed: ${formatNumber(state.quantities.dispensedQty)} kg\n` +
                   `‚Ä¢ Remaining: ${formatNumber(state.quantities.remainingQty)} kg\n\n` +
                   `*Click on remaining quantity to use it as Q in next calculation*`;
        }

        function updateDispensedQuantity(formulaType, Q, result) {
            const resultNum = parseFloat(result);
            
            if (formulaType === "F2") {
                state.quantities.dispensedQty += parseFloat(Q);
            } else {
                state.quantities.dispensedQty += resultNum;
            }
            
            updateQuantities();
        }

        function updateQuantities() {
            state.quantities.remainingQty = state.quantities.stdQty - state.quantities.dispensedQty;
            
            // Update UI
            elements.statusStdQty.textContent = formatNumber(state.quantities.stdQty);
            elements.statusDispensed.textContent = formatNumber(state.quantities.dispensedQty);
            elements.statusRemaining.textContent = formatNumber(state.quantities.remainingQty);
            elements.statusCalculations.textContent = state.calculations.length;
        }

        // ============================================================================
        // ACB CALCULATOR FUNCTIONS
        // ============================================================================
        function handleACBCommand(text) {
            if (text.includes('show') || text.includes('display')) {
                return getACBStatus();
            }
            
            if (text.includes('reset')) {
                return resetACBCalculator();
            }
            
            // Try to parse lot updates
            const lotUpdate = parseLotUpdate(text);
            if (lotUpdate) {
                return updateACBValue(lotUpdate.lot, lotUpdate.type, lotUpdate.value);
            }
            
            return getACBStatus();
        }

        function parseLotUpdate(text) {
            const pattern = /lot\s*(\d+)\s*(a|b|c)[=:\s]+([\d.]+)/i;
            const match = text.match(pattern);
            
            if (match) {
                return {
                    lot: parseInt(match[1]) - 1, // Convert to 0-based index
                    type: match[2].toLowerCase(),
                    value: parseFloat(match[3])
                };
            }
            return null;
        }

        function updateACBValue(lotIndex, type, value) {
            if (lotIndex < 0 || lotIndex > 3 || isNaN(value)) {
                return "‚ùå Invalid lot or value. Please use format: 'Lot 1 B=100'";
            }
            
            if (type === 'a' || type === 'c') {
                // Update all lots if it's a standard value
                for (let i = 0; i < 4; i++) {
                    state.acbState.values[type][i] = value;
                }
            } else {
                state.acbState.values[type][lotIndex] = value;
            }
            
            // Recalculate totals
            recalculateACBTotals();
            
            return `‚úÖ Updated Lot ${lotIndex + 1} ${type.toUpperCase()} to ${formatNumber(value)}`;
        }

        function recalculateACBTotals() {
            // Calculate totals
            state.acbState.totals.a = state.acbState.values.a.reduce((sum, val) => sum + val, 0);
            state.acbState.totals.b = state.acbState.values.b.reduce((sum, val) => sum + val, 0);
            state.acbState.totals.c = state.acbState.values.c.reduce((sum, val) => sum + val, 0);
            state.acbState.totals.result = state.acbState.totals.a + state.acbState.totals.c - state.acbState.totals.b;
        }

        function resetACBCalculator() {
            state.acbState = {
                values: {
                    a: [CONSTANTS.ACB_DEFAULT_A, CONSTANTS.ACB_DEFAULT_A, CONSTANTS.ACB_DEFAULT_A, CONSTANTS.ACB_DEFAULT_A],
                    b: [0, 0, 0, 0],
                    c: [CONSTANTS.ACB_DEFAULT_C, CONSTANTS.ACB_DEFAULT_C, CONSTANTS.ACB_DEFAULT_C, CONSTANTS.ACB_DEFAULT_C]
                },
                totals: {
                    a: CONSTANTS.ACB_TOTAL_A,
                    b: 0,
                    c: CONSTANTS.ACB_TOTAL_C,
                    result: 0
                }
            };
            
            return "‚úÖ ACB Calculator has been reset to default values.";
        }

        function getACBStatus() {
            let response = `üìä **(A+C)-B Calculator Status:**\n\n`;
            
            response += `**Standard Quantities (A):**\n`;
            state.acbState.values.a.forEach((val, i) => {
                response += `Lot ${i + 1}: ${formatNumber(val)} kg\n`;
            });
            response += `Total A: ${formatNumber(state.acbState.totals.a)} kg\n\n`;
            
            response += `**Issued Quantities (B):**\n`;
            state.acbState.values.b.forEach((val, i) => {
                response += `Lot ${i + 1}: ${formatNumber(val)} kg\n`;
            });
            response += `Total B: ${formatNumber(state.acbState.totals.b)} kg\n\n`;
            
            response += `**Standard Quantities (C):**\n`;
            state.acbState.values.c.forEach((val, i) => {
                response += `Lot ${i + 1}: ${formatNumber(val)} kg\n`;
            });
            response += `Total C: ${formatNumber(state.acbState.totals.c)} kg\n\n`;
            
            response += `**Results ((A+C)-B):**\n`;
            for (let i = 0; i < 4; i++) {
                const result = state.acbState.values.a[i] + state.acbState.values.c[i] - state.acbState.values.b[i];
                response += `Lot ${i + 1}: ${formatNumber(result)} kg\n`;
            }
            response += `Total Result: ${formatNumber(state.acbState.totals.result)} kg\n\n`;
            
            response += `*To update, use: 'Lot 1 B=100' or 'Set Lot 2 A=450'*`;
            
            return response;
        }

        // ============================================================================
        // OTHER COMMAND HANDLERS
        // ============================================================================
        function getHelpMessage() {
            return `ü§ñ **NIR8 Chat Calculator Help**\n\n` +
                   `**Formula Calculations:**\n` +
                   `‚Ä¢ Calculate F1 Q=100 W=5 A=95\n` +
                   `‚Ä¢ Calculate F2 with Q=500 W=3 A=98\n` +
                   `‚Ä¢ F3 Q=1000 W=2 A=99\n\n` +
                   `**Quantity Tracking:**\n` +
                   `‚Ä¢ Set std qty 1500\n` +
                   `‚Ä¢ Show quantities\n` +
                   `‚Ä¢ Use remaining as Q\n\n` +
                   `**ACB Calculator:**\n` +
                   `‚Ä¢ Show ACB\n` +
                   `‚Ä¢ Lot 1 B=100\n` +
                   `‚Ä¢ Lot 2 A=450\n` +
                   `‚Ä¢ Reset ACB\n\n` +
                   `**Other Commands:**\n` +
                   `‚Ä¢ Help\n` +
                   `‚Ä¢ Clear calculations\n` +
                   `‚Ä¢ Print report\n` +
                   `‚Ä¢ Clear chat\n\n` +
                   `*You can also use the quick action buttons in the sidebar.*`;
        }

        function handleClearCommand(text) {
            if (text.includes('calculation') || text.includes('calc')) {
                return clearAllCalculations();
            } else if (text.includes('chat')) {
                return clearChat();
            } else {
                return clearAllCalculations();
            }
        }

        function handlePrintCommand() {
            if (state.calculations.length === 0) {
                return "‚ùå No calculations to print. Please perform some calculations first.";
            }
            
            // Show the calculation steps container
            elements.calculationSteps.classList.add('active');
            
            setTimeout(() => {
                printWithCheck();
            }, 500);
            
            return `‚úÖ Ready to print ${state.calculations.length} calculations. The print preview will open shortly.`;
        }

        // ============================================================================
        // UI FUNCTIONS
        // ============================================================================
        function sendMessage(text) {
            elements.userInput.value = text;
            sendUserMessage();
        }

        function sendUserMessage() {
            const text = elements.userInput.value.trim();
            if (!text) return;
            
            addMessage('user', text);
            elements.userInput.value = '';
            
            processMessage(text);
        }

        function handleInputKeyPress(event) {
            if (event.key === 'Enter') {
                sendUserMessage();
            }
        }

        function updateStatus() {
            elements.modeIndicator.textContent = state.currentMode.charAt(0).toUpperCase() + state.currentMode.slice(1);
            elements.statusCalculations.textContent = state.calculations.length;
        }

        function clearChat() {
            if (confirm('Clear all chat messages?')) {
                elements.messagesContainer.innerHTML = '';
                state.messages = [];
                addMessage('system', 'Chat cleared. How can I help you?');
            }
            return "‚úÖ Chat cleared.";
        }

        function clearAllCalculations() {
            if (state.calculations.length === 0) {
                return "‚ùå No calculations to clear.";
            }
            
            if (confirm(`Clear all ${state.calculations.length} calculations?`)) {
                state.calculations = [];
                state.quantities.dispensedQty = 0;
                state.quantities.remainingQty = state.quantities.stdQty;
                elements.stepsContainer.innerHTML = '';
                elements.calculationSteps.classList.add('hidden');
                updateQuantities();
                return "‚úÖ All calculations cleared.";
            }
            return "‚ùå Operation cancelled.";
        }

        function showFormulaCalculator() {
            const calculatorHTML = `
                <div class="form-inputs">
                    <h3>üßÆ Formula Calculator</h3>
                    <p>Enter values for calculation:</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chatQ">Quantity (Q):</label>
                            <input type="number" id="chatQ" step="0.001" min="0.001" placeholder="Enter quantity">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="chatW">Water Content (W):</label>
                            <input type="number" id="chatW" step="0.01" min="0.01" max="99.99" placeholder="Enter water content">
                        </div>
                        <div class="form-group">
                            <label for="chatA">Assay Content (A):</label>
                            <input type="number" id="chatA" step="0.01" min="0.01" max="100.00" placeholder="Enter assay content">
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button class="calc-btn f1" onclick="calculateFromForm('F1')">Calculate F1</button>
                        <button class="calc-btn f2" onclick="calculateFromForm('F2')">Calculate F2</button>
                        <button class="calc-btn f3" onclick="calculateFromForm('F3')">Calculate F3</button>
                    </div>
                </div>
            `;
            
            addMessage('bot', calculatorHTML);
        }

        function calculateFromForm(formulaType) {
            const Q = document.getElementById('chatQ')?.value;
            const W = document.getElementById('chatW')?.value;
            const A = document.getElementById('chatA')?.value;
            
            if (!Q || !W || !A) {
                addMessage('bot', "‚ùå Please fill in all fields.");
                return;
            }
            
            const result = performFormulaCalculation(formulaType, Q, W, A);
            addMessage('bot', result);
        }

        function showACBCalculator() {
            addMessage('bot', getACBStatus());
        }

        function useRemainingAsQ() {
            if (state.quantities.remainingQty > 0) {
                if (confirm(`Use remaining quantity (${formatNumber(state.quantities.remainingQty)}) as Q?`)) {
                    showFormulaCalculator();
                    setTimeout(() => {
                        const qInput = document.getElementById('chatQ');
                        if (qInput) {
                            qInput.value = formatNumber(state.quantities.remainingQty);
                        }
                    }, 100);
                }
            }
        }

        function promptSetStdQty() {
            const newQty = prompt("Enter new standard quantity (kg):", formatNumber(state.quantities.stdQty));
            if (newQty && !isNaN(parseFloat(newQty))) {
                state.quantities.stdQty = parseFloat(newQty);
                updateQuantities();
                addMessage('bot', `‚úÖ Standard quantity set to ${formatNumber(state.quantities.stdQty)} kg`);
            }
        }

        // ============================================================================
        // PRINT FUNCTIONS (From Original)
        // ============================================================================
        function printWithCheck() {
            if (window.innerWidth <= 768 && !confirm("For optimal printing, use a larger screen or PC. Continue?")) {
                return;
            }
            
            // Hide chat interface during print
            document.querySelector('.chat-container').classList.add('hidden');
            elements.calculationSteps.classList.remove('hidden');
            
            setTimeout(() => {
                window.print();
                
                // Restore chat interface after print
                setTimeout(() => {
                    document.querySelector('.chat-container').classList.remove('hidden');
                    elements.calculationSteps.classList.add('hidden');
                }, 500);
            }, 500);
        }

        function printAllCalculations() {
            if (state.calculations.length === 0) {
                addMessage('bot', "‚ùå No calculations to print.");
                return;
            }
            
            // Show calculation steps
            elements.calculationSteps.classList.add('active');
            
            setTimeout(() => {
                printWithCheck();
            }, 100);
            
            addMessage('bot', `‚úÖ Preparing ${state.calculations.length} calculations for printing...`);
        }

        // ============================================================================
        // ORIGINAL FUNCTIONS (Adapted for Chat)
        // ============================================================================
        function deleteCalculation(button) {
            if (!confirm("Are you sure you want to delete this calculation?")) return;
            
            const entry = button.parentElement;
            const entries = Array.from(elements.stepsContainer.children);
            const entryIndex = entries.indexOf(entry);
            const arrayIndex = state.calculations.length - 1 - entryIndex;
            
            if (arrayIndex >= 0 && arrayIndex < state.calculations.length) {
                // Update dispensed quantity
                const calc = state.calculations[arrayIndex];
                if (calc.formulaType === "F2") {
                    state.quantities.dispensedQty -= parseFloat(calc.Q);
                } else {
                    state.quantities.dispensedQty -= parseFloat(calc.result);
                }
                
                // Remove calculation
                state.calculations.splice(arrayIndex, 1);
                
                // Update quantities
                updateQuantities();
            }
            
            entry.remove();
            
            if (state.calculations.length === 0) {
                elements.calculationSteps.classList.add('hidden');
            }
            
            addMessage('bot', "‚úÖ Calculation deleted.");
        }

        // ============================================================================
        // HELPER FUNCTIONS
        // ============================================================================
        function extractNumber(text) {
            const match = text.match(/(\d+(\.\d+)?)/);
            return match ? parseFloat(match[1]) : NaN;
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        function init() {
            // Initialize Decimal.js
            if (typeof Decimal !== 'undefined') {
                Decimal.set({ precision: 20, toExpNeg: -9, toExpPos: 20 });
            }
            
            // Initialize state
            updateQuantities();
            updateStatus();
            
            // Set up event listeners
            elements.userInput.focus();
            
            // Welcome message
            addMessage('bot', getHelpMessage());
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>