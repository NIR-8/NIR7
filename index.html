<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light only">
<title>NIR8 Calculators</title>

<!-- MathJax -->
<script>
MathJax = {
    loader: { load: ['input/tex', 'output/chtml'] },
    tex: { inlineMath: [['\( ',' \)'], ['\\(','\\)']], packages: {'[+]': ['base','ams']}, processEscapes: true },
    chtml: { scale: 0.9, mtextInheritFont: true },
    startup: { typeset: false, pageReady() { MathJax.startup.defaultPageReady(); document.dispatchEvent(new Event('MathJaxReady')); } }
};
</script>

<!-- Decimal.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>

<style>
:root {
    --primary: #28a745;
    --primary-dark: #218838;
    --danger: #dc3545;
    --light-gray: #f8f9fa;
    --dark: #212529;
}

* { box-sizing: border-box; margin:0; padding:0; }

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    min-height: 100vh;
    color: #333;
    padding-top: 90px;
}

/* ── Full-screen initial overlay ──────────────────────────────────────── */
#qtyOverlay {
    position: fixed;
    inset: 0;
    background: rgba(20,30,50,0.9);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    transition: opacity 0.7s ease;
}

#qtyOverlay.hidden { opacity: 0; pointer-events: none; }

.overlay-content {
    background: white;
    padding: 3.2rem 4rem;
    border-radius: 16px;
    box-shadow: 0 24px 64px rgba(0,0,0,0.45);
    text-align: center;
    max-width: 520px;
    width: 92%;
    transform: scale(0.9);
    opacity: 0;
    animation: popupIn 0.65s 0.25s forwards cubic-bezier(0.34,1.56,0.64,1);
}

@keyframes popupIn {
    to { transform: scale(1); opacity: 1; }
}

.overlay-content h2 {
    margin-bottom: 1.5rem;
    font-size: 1.9rem;
    color: var(--dark);
    font-weight: 600;
}

#stdQtyOverlay {
    width: 280px;
    font-size: 2.6rem;
    font-weight: 500;
    padding: 0.9rem;
    text-align: center;
    border: 2px solid #dee2e6;
    border-radius: 12px;
    transition: all 0.25s;
}

#stdQtyOverlay:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(40,167,69,0.2);
    outline: none;
}

#qtyWarning {
    margin-top: 1.1rem;
    color: var(--danger);
    font-size: 1.1rem;
    min-height: 1.5em;
}

/* Curtain lift animation */
#qtyOverlay.curtain-lift {
    animation: curtainUp 950ms cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

@keyframes curtainUp {
    to { transform: translateY(-100%); }
}

/* ── Menu Bar ─────────────────────────────────────────────────────────── */
.menu-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: rgba(20,30,50,0.92);
    backdrop-filter: blur(10px);
    color: white;
    z-index: 999;
    padding: 1rem 0;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.menu-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1.6rem;
    display: flex;
    align-items: center;
    gap: 1.8rem;
    flex-wrap: wrap;
}

.menu-item {
    padding: 0.65rem 1.4rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.25s;
}

.menu-item:hover { background: rgba(255,255,255,0.13); }
.menu-item.active { background: var(--primary); }

.menu-qty-tracker {
    display: flex;
    align-items: center;
    gap: 1.8rem;
    margin-left: auto;
}

.menu-qty-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.menu-qty-label {
    font-size: 0.8rem;
    color: #adb5bd;
    margin-bottom: 0.4rem;
}

.menu-qty-input, .lot-select {
    padding: 0.55rem 0.9rem;
    border: 1px solid #495057;
    border-radius: 6px;
    background: white;
    color: #212529;
    font-size: 1.05rem;
    width: 124px;
    text-align: center;
}

.menu-qty-value {
    font-size: 1.2rem;
    font-weight: 600;
}

.menu-qty-warning {
    color: #ff6b6b;
    font-size: 0.78rem;
    margin-top: 0.35rem;
    background: rgba(220,53,69,0.15);
    padding: 0.25rem 0.65rem;
    border-radius: 4px;
    display: none;
}

.menu-qty-warning.active { display: inline-block; }

/* ── Calculator containers ────────────────────────────────────────────── */
.calculator-container {
    background: white;
    margin: 2.5rem auto;
    padding: 2.5rem;
    width: 92%;
    max-width: 1000px;
    border-radius: 16px;
    box-shadow: 0 12px 48px rgba(0,0,0,0.16);
    display: none;
}

.calculator-container.active { display: block; }

/* A+C-B table */
.acb-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.8rem 0;
}

.acb-th, .acb-td {
    border: 1px solid #dee2e6;
    padding: 1rem;
    text-align: center;
}

.acb-th {
    background: var(--light-gray);
    font-weight: 600;
    color: var(--dark);
}

.acb-input {
    width: 100%;
    padding: 0.6rem;
    font-size: 1rem;
    text-align: center;
    border: 1px solid #ced4da;
    border-radius: 6px;
    transition: border-color 0.2s;
}

.acb-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(40,167,69,0.15);
}

.acb-span { font-weight: 500; }

/* Add lot button */
.add-lot-btn {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    margin-left: 14px;
    transition: background 0.2s;
}

.add-lot-btn:hover { background: var(--primary-dark); }

/* Calculation entries / print styles would go here - kept minimal for brevity */
.calculation-steps {
    background: white;
    margin: 2rem auto;
    padding: 2rem;
    max-width: 1000px;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
}

.calculation-entry {
    border: 1px solid #000;
    margin: 2rem 0;
    padding: 5rem 1.5rem 4rem;
    min-height: 240px;
    position: relative;
    background: white;
}
</style>
</head>
<body>

<!-- Initial full-screen qty input overlay -->
<div id="qtyOverlay">
    <div class="overlay-content">
        <h2>Theoretical Standard Quantity <small>(per lot)</small></h2>
        <input type="number" id="stdQtyOverlay" step="0.001" min="0.001" placeholder="500.000" autofocus>
        <div id="qtyWarning"></div>
    </div>
</div>

<!-- Fixed menu bar -->
<div class="menu-bar">
    <div class="menu-container">
        <div class="menu-item active" id="menuFormula">Formula Calculator</div>
        <div class="menu-item" id="menuAcb">(A+C)-B Calculator</div>

        <div class="menu-qty-tracker">
            <div class="menu-qty-group">
                <label class="menu-qty-label">Std Qty (kg) per lot</label>
                <input type="number" id="stdQty" class="menu-qty-input" step="0.001" placeholder="Enter qty">
            </div>
            <div class="menu-qty-group">
                <label class="menu-qty-label">Dispensed</label>
                <div id="dispensedQty" class="menu-qty-value">0.000</div>
            </div>
            <div class="menu-qty-group">
                <label class="menu-qty-label">Remaining</label>
                <div id="remainingQty" class="menu-qty-value">-</div>
                <div id="quantityWarning" class="menu-qty-warning">Qty mismatch!</div>
            </div>
            <div class="menu-qty-group" id="lotSelectGroup" style="display:none;">
                <label class="menu-qty-label">Assign to Lot</label>
                <select id="lotSelect" class="lot-select">
                    <option value="" disabled selected>Select</option>
                    <option value="1">I</option>
                    <option value="2">II</option>
                    <option value="3">III</option>
                    <option value="4">IV</option>
                    <option value="5">V</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Main content area - add your original calculator HTML here -->
<div id="formulaCalculator" class="calculator-container active">
    <h2>Formula Calculator</h2>
    <!-- Your original formula calculator fields/buttons go here -->
    <p style="color:#666; font-style:italic;">(Formula calculator content placeholder)</p>
</div>

<div id="acbCalculator" class="calculator-container">
    <h2>(A+C)-B Calculator</h2>
    <table class="acb-table" id="acbTable">
        <thead>
            <tr id="tableHeader">
                <th></th>
                <!-- Lot columns will be added here dynamically -->
                <th>TOTAL (kg)</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Rows will be populated dynamically -->
        </tbody>
    </table>
</div>

<!-- Calculation steps / print area -->
<div class="calculation-steps" id="calculationSteps" style="display:none;">
    <div id="stepsContainer"></div>
</div>

<script>
// ============================================================================
//                           MAIN APPLICATION LOGIC
// ============================================================================

const LOT_ROMAN = ['I','II','III','IV','V'];
let visibleLots = 1;           // starts with only Lot I
let calculations = [];

// DOM references
const els = {
    overlay: document.getElementById('qtyOverlay'),
    overlayInput: document.getElementById('stdQtyOverlay'),
    qtyWarning: document.getElementById('qtyWarning'),
    stdQty: document.getElementById('stdQty'),
    dispensedQty: document.getElementById('dispensedQty'),
    remainingQty: document.getElementById('remainingQty'),
    lotSelect: document.getElementById('lotSelect'),
    lotSelectGroup: document.getElementById('lotSelectGroup'),
    tableHeader: document.getElementById('tableHeader'),
    tableBody: document.getElementById('tableBody')
};

// ── Overlay handling ───────────────────────────────────────────────────────
function tryFinishOverlay() {
    const val = els.overlayInput.value.trim();
    const num = parseFloat(val);

    if (!val || isNaN(num) || num <= 0) {
        els.qtyWarning.textContent = "Please enter a valid positive quantity";
        els.overlayInput.focus();
        return false;
    }

    els.qtyWarning.textContent = "";
    els.stdQty.value = val;
    els.overlay.classList.add('curtain-lift');

    setTimeout(() => {
        els.overlay.classList.add('hidden');
        els.overlay.style.display = 'none';
        syncStdQtyToAllVisibleLots();
        updateACB();
    }, 1000);

    return true;
}

els.overlayInput.addEventListener('input', tryFinishOverlay);
els.overlayInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        e.preventDefault();
        tryFinishOverlay();
    }
});

// ── Dynamic A+C-B table creation ───────────────────────────────────────────
function createACBTable() {
    const types = [
        { label: 'Std. Qty (A) kg', id: 'a' },
        { label: 'Issued Qty (B) kg', id: 'b' },
        { label: 'Std. Qty (C) kg', id: 'c' },
        { label: '(A+C)-B kg', id: 'result' }
    ];

    // Create rows
    types.forEach(({label, id}) => {
        const tr = document.createElement('tr');
        const labelTd = document.createElement('td');
        labelTd.textContent = label;
        tr.appendChild(labelTd);

        // Will be filled later with dynamic cells
        els.tableBody.appendChild(tr);
    });

    // Initial visible lots (only Lot I)
    updateVisibleLots();
}

function updateVisibleLots() {
    // Clear existing dynamic columns (except label & total)
    while (els.tableHeader.children.length > 2) {
        els.tableHeader.removeChild(els.tableHeader.children[1]);
    }

    for (let i = 1; i <= visibleLots; i++) {
        const th = document.createElement('th');
        th.textContent = `Lot-${LOT_ROMAN[i-1]}`;
        els.tableHeader.insertBefore(th, els.tableHeader.lastElementChild);

        // Add cells to each row
        const rows = els.tableBody.children;
        for (let r = 0; r < rows.length; r++) {
            const type = ['a','b','c','result'][r];
            const td = document.createElement('td');

            if (type === 'result') {
                const span = document.createElement('span');
                span.id = `lot${i}-result`;
                span.textContent = '-';
                td.appendChild(span);
            } else {
                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.001';
                input.className = 'acb-input';
                input.id = `lot\( {i}- \){type}`;
                input.value = '';
                td.appendChild(input);
            }

            rows[r].insertBefore(td, rows[r].lastElementChild);
        }
    }

    // Add + button to last visible lot header if not max
    if (visibleLots < LOT_ROMAN.length) {
        const lastTh = els.tableHeader.children[visibleLots];
        if (!lastTh.querySelector('.add-lot-btn')) {
            const btn = document.createElement('button');
            btn.className = 'add-lot-btn';
            btn.textContent = '+';
            btn.onclick = () => {
                visibleLots++;
                updateVisibleLots();
                syncStdQtyToAllVisibleLots();
            };
            lastTh.appendChild(btn);
        }
    }

    syncStdQtyToAllVisibleLots();
    updateACB();
}

function syncStdQtyToAllVisibleLots() {
    const value = els.stdQty.value.trim();
    if (!value) return;

    for (let i = 1; i <= visibleLots; i++) {
        const aInput = document.getElementById(`lot${i}-a`);
        if (aInput) aInput.value = value;
    }
    updateACB();
}

// ── ACB calculation logic ──────────────────────────────────────────────────
function updateACB() {
    let totalA = 0, totalB = 0, totalC = 0, totalRes = 0;

    for (let i = 1; i <= visibleLots; i++) {
        const a = parseFloat(document.getElementById(`lot${i}-a`)?.value || 0);
        const b = parseFloat(document.getElementById(`lot${i}-b`)?.value || 0);
        const c = parseFloat(document.getElementById(`lot${i}-c`)?.value || 0);
        const result = a + c - b;

        const resultEl = document.getElementById(`lot${i}-result`);
        if (resultEl) resultEl.textContent = Number.isNaN(result) ? '-' : result.toFixed(3);

        totalA += a;
        totalB += b;
        totalC += c;
        totalRes += result;
    }

    // Update totals row (last cell of each row)
    const totalCells = els.tableBody.querySelectorAll('tr td:last-child span');
    if (totalCells.length === 4) {
        totalCells[0].textContent = totalA.toFixed(3);
        totalCells[1].textContent = totalB.toFixed(3);
        totalCells[2].textContent = totalC.toFixed(3);
        totalCells[3].textContent = totalRes.toFixed(3);
    }
}

// ── Lot selection → show lot + assign dispensed value ──────────────────────
els.lotSelect.addEventListener('change', () => {
    const idx = parseInt(els.lotSelect.value);
    if (isNaN(idx) || idx < 1) return;

    if (idx > visibleLots) {
        visibleLots = idx;
        updateVisibleLots();
    }

    // Assign current dispensed value to selected lot B
    const bInput = document.getElementById(`lot${idx}-b`);
    if (bInput && els.dispensedQty.textContent !== '0.000') {
        bInput.value = els.dispensedQty.textContent;
    }

    updateACB();
    els.lotSelect.value = '';
});

// ── Input listeners ────────────────────────────────────────────────────────
els.stdQty.addEventListener('input', syncStdQtyToAllVisibleLots);

document.getElementById('acbCalculator').addEventListener('input', e => {
    if (e.target.classList.contains('acb-input')) {
        updateACB();
    }
});

// ── Initialize ─────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
    createACBTable();
    // Focus overlay input automatically
    els.overlayInput.focus();
});
</script>
</body>
</html>